# ZDK Testing Guide

**Created:** 2025-11-19 14:25  
**Last Updated:** 2025-11-19 14:25  
**Status:** Active

## Purpose

This document provides comprehensive guidance for testing ZDK components, including running tests, understanding test coverage, and adding new tests.

## Test Coverage

ZDK includes comprehensive high-impact E2E tests that verify critical functionality across the stack.

### Test Structure

```
rak/
├── crates/
│   ├── zdk-session/src/lib.rs    # Session management tests
│   ├── zdk-agent/src/lib.rs      # Agent builder tests
│   └── zdk-runner/src/lib.rs     # Runner orchestration tests
└── tests/
    └── integration_test.rs        # Full E2E integration tests
```

## Running Tests

### All Tests
```bash
cd rak
cargo test
```

### Unit Tests Only
```bash
cargo test --lib
```

### Integration Tests Only
```bash
cargo test --test integration_test
```

### Specific Package
```bash
cargo test --package zdk-session
cargo test --package zdk-runner
```

## Test Categories

### 1. Session Management Tests (`zdk-session`)

**Purpose**: Verify session lifecycle and event persistence

**Tests**:
- `test_create_session` - Session creation with custom ID
- `test_get_session` - Session retrieval
- `test_append_events` - Event history tracking

**Impact**: High - Core functionality for conversation state

### 2. Agent Builder Tests (`zdk-agent`)

**Purpose**: Validate agent construction and configuration

**Tests**:
- `test_builder_creates_agent` - Builder pattern works correctly
- `test_builder_requires_name` - Validation of required fields
- `test_builder_requires_model` - Model dependency validation

**Impact**: High - Entry point for all agent creation

### 3. Runner Tests (`zdk-runner`)

**Purpose**: Test agent execution orchestration

**Tests**:
- `test_runner_executes_agent` - Basic execution flow
- `test_runner_persists_events` - Event persistence to session

**Impact**: Critical - Core execution engine

### 4. Integration Tests (E2E)

**Purpose**: Verify full stack functionality

#### `test_e2e_session_and_agent_execution`
- **What it tests**: Complete flow from session creation through agent execution
- **Covers**:
  - Session creation
  - LLM agent execution
  - Event generation
  - Event persistence
  - Response structure validation
- **Impact**: ⭐⭐⭐⭐⭐ Critical path

#### `test_e2e_streaming_events`
- **What it tests**: Streaming response handling
- **Covers**:
  - Partial event generation
  - Turn completion
  - Streaming mode behavior
- **Impact**: ⭐⭐⭐⭐⭐ Essential for UX

#### `test_e2e_multiple_turns_in_session`
- **What it tests**: Multi-turn conversations
- **Covers**:
  - Session continuity
  - Event accumulation
  - Context preservation
- **Impact**: ⭐⭐⭐⭐ Core conversation feature

#### `test_event_format_matches_spec`
- **What it tests**: Go ZDK API compatibility
- **Covers**:
  - JSON serialization format
  - camelCase field naming
  - Required fields presence
- **Impact**: ⭐⭐⭐⭐⭐ Critical for interoperability

#### `test_content_serialization`
- **What it tests**: Content type serialization
- **Covers**:
  - Round-trip serialization
  - Part structure
  - Role preservation
- **Impact**: ⭐⭐⭐ Data integrity

## Test Results

```bash
$ cargo test

Running unittests src/lib.rs (target/debug/deps/rak_session-...)
running 3 tests
test tests::test_append_events ... ok
test tests::test_create_session ... ok
test tests::test_get_session ... ok
test result: ok. 3 passed

Running unittests src/lib.rs (target/debug/deps/rak_agent-...)
running 3 tests
test tests::test_builder_creates_agent ... ok
test tests::test_builder_requires_name ... ok
test tests::test_builder_requires_model ... ok
test result: ok. 3 passed

Running unittests src/lib.rs (target/debug/deps/rak_runner-...)
running 2 tests
test tests::test_runner_executes_agent ... ok
test tests::test_runner_persists_events ... ok
test result: ok. 2 passed

Running tests/integration_test.rs (target/debug/deps/integration_test-...)
running 5 tests
test test_event_format_matches_spec ... ok
test test_content_serialization ... ok
test test_e2e_streaming_events ... ok
test test_e2e_multiple_turns_in_session ... ok
test test_e2e_session_and_agent_execution ... ok
test result: ok. 5 passed

Total: 13 tests passed
```

## Mock LLM for Testing

The test suite includes a `TestLLM` mock implementation:

```rust
struct TestLLM {
    responses: Vec<String>,
}
```

**Features**:
- Deterministic responses
- Streaming simulation
- Configurable outputs
- No external API calls

**Usage**:
```rust
let llm = Arc::new(TestLLM::new(vec!["Hello!", "Response"]));
let agent = LLMAgent::builder()
    .model(llm)
    .build()?;
```

## Test Design Principles

### 1. High-Impact Focus
Tests cover the most critical paths that users will exercise:
- Session creation and persistence
- Agent execution
- Event streaming
- API format compatibility

### 2. E2E Over Unit
Integration tests verify full stack behavior rather than isolated components:
- Real interactions between components
- Actual data flow
- Complete execution paths

### 3. Deterministic
- Uses mock LLM for reproducible results
- No external API dependencies
- Fast execution (< 1 second)

### 4. Minimal Setup
- Simple test helpers
- Clear test structure
- Easy to understand and maintain

## Adding New Tests

### Unit Tests (in crate)

Add to `crates/<crate>/src/lib.rs`:

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_new_feature() {
        // Your test here
    }
    
    #[tokio::test]
    async fn test_async_feature() {
        // Your async test here
    }
}
```

### Integration Tests

Add to `tests/integration_test.rs`:

```rust
#[tokio::test]
async fn test_new_e2e_scenario() {
    // Setup
    let llm = Arc::new(TestLLM::new(vec!["Response"]));
    let agent = LLMAgent::builder()
        .name("test-agent")
        .model(llm)
        .build()
        .unwrap();
    
    // Execute
    // ...
    
    // Verify
    assert!(...);
}
```

## Test Performance

- **Unit tests**: ~0.01s per test
- **Integration tests**: ~0.01s per test
- **Total suite**: < 1 second
- **Parallel execution**: Yes (via cargo)

## CI/CD Integration

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - run: cargo test --all-features
```

## Coverage Goals

- **Critical paths**: 100% (session, runner, agent execution)
- **API compatibility**: 100% (event format, endpoints)
- **Error handling**: 80%+
- **Edge cases**: Add as discovered

## Debugging Tests

### Run specific test
```bash
cargo test test_e2e_session_and_agent_execution -- --nocapture
```

### Show test output
```bash
cargo test -- --nocapture --test-threads=1
```

### Run with backtrace
```bash
RUST_BACKTRACE=1 cargo test
```

## Future Test Additions

When implementing new features, add tests for:

### Phase 2: Tool System
- Tool execution
- Tool schema generation
- Function tool macro

### Phase 3: Advanced Agents
- Sequential agent orchestration
- Parallel agent execution
- Loop agent behavior

### Phase 4: Storage Providers
- PostgreSQL session persistence
- SQLite session persistence
- GCS artifact storage

### Phase 5: REST API
- Session creation endpoint
- Batch execution endpoint
- SSE streaming endpoint
- Error responses

---

**Test Philosophy**: High-impact, E2E-focused tests that verify real-world usage patterns and ensure API compatibility with Go ZDK.

