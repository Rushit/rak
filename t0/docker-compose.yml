# This is a simplified example for learning purposes. Do not use this in production.
# For production-ready deployments, see: https://www.tensorzero.com/docs/deployment/tensorzero-gateway
#
# Configuration:
# 1. Copy env.example to .env
# 2. Add your API keys to .env
# 3. Run: docker-compose up

services:
  clickhouse:
    image: clickhouse/clickhouse-server:25.10-alpine
    environment:
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-chusertoxi}
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-chpasswordtoxi$$43}
    ports:
      - "8123:8123"
    volumes:
      - ./data/clickhouse:/var/lib/clickhouse
      - ./config/clickhouse:/etc/clickhouse-server/config.d/:ro
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://${CLICKHOUSE_USER:-chusertoxi}:${CLICKHOUSE_PASSWORD:-chpasswordtoxi$$43}@127.0.0.1:8123/ping || exit 1
      start_period: 30s
      start_interval: 1s
      timeout: 1s
      retries: 3

  postgres:
    image: postgres:17-alpine
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-tensorzero}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-tensorzeropass}
      - POSTGRES_DB=${POSTGRES_DB:-tensorzero}
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "8188:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-tensorzero} -d $${POSTGRES_DB:-tensorzero}"]
      start_period: 10s
      interval: 5s
      timeout: 3s
      retries: 3

  # The TensorZero Python client *doesn't* require a separate gateway service.
  #
  # The gateway is only needed if you want to use the OpenAI Python client
  # or interact with TensorZero via its HTTP API (for other programming languages).
  #
  # The TensorZero UI also requires the gateway service.
  gateway:
    image: tensorzero/gateway
    volumes:
      # Mount our tensorzero.toml file into the container
      - ./config:/app/config:ro
    command: --config-file /app/config/tensorzero.toml
    environment:
      - TENSORZERO_CLICKHOUSE_URL=http://${CLICKHOUSE_USER:-chusertoxi}:${CLICKHOUSE_PASSWORD:-chpasswordtoxi$$43}@clickhouse:8123/tensorzero
      - TENSORZERO_POSTGRES_URL=postgres://${POSTGRES_USER:-tensorzero}:${POSTGRES_PASSWORD:-tensorzeropass}@postgres:5432/${POSTGRES_DB:-tensorzero}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_AI_STUDIO_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    ports:
      - "8181:8181"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy

  ui:
    image: tensorzero/ui
    volumes:
      # Mount our tensorzero.toml file into the container
      - ./config:/app/config:ro
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GOOGLE_AI_STUDIO_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - TENSORZERO_CLICKHOUSE_URL=http://${CLICKHOUSE_USER:-chusertoxi}:${CLICKHOUSE_PASSWORD:-chpasswordtoxi$$43}@clickhouse:8123/tensorzero
      - TENSORZERO_POSTGRES_URL=postgres://${POSTGRES_USER:-tensorzero}:${POSTGRES_PASSWORD:-tensorzeropass}@postgres:5432/${POSTGRES_DB:-tensorzero}
      - TENSORZERO_GATEWAY_URL=http://gateway:8181
    ports:
      - "4000:4000"
    depends_on:
      clickhouse:
        condition: service_healthy
      postgres:
        condition: service_healthy